#ØªØºÛŒÛŒØ± Ø¯Ø± Ø³Ø§ÙˆÙ„  Ø¯ÙˆÙ…
  # =================================================================
# Ø³Ù„ÙˆÙ„ Û²: Ù…Ø¯Ù„Ø³Ø§Ø²ÛŒ XGBoost Ø¨Ø§ TF-IDF Ùˆ SMOTE
# =================================================================
%%time

MODEL_NAME = "XGBoost_TFIDF_SMOTE" 

# --- Û±. ØªØ¹Ø±ÛŒÙ Ø§Ø¬Ø²Ø§ÛŒ Pipeline ---
from sklearn.feature_extraction.text import TfidfVectorizer 
from imblearn.pipeline import Pipeline as ImbPipeline 
from imblearn.over_sampling import SMOTE 
from xgboost import XGBClassifier
from sklearn.metrics import make_scorer, f1_score
from sklearn.model_selection import GridSearchCV
import time

# ğŸš¨ TF-IDFVectorizer (Embedding Ø³Ù†ØªÛŒ Ø§ÙˆÙ„)
tfidf_vectorizer = TfidfVectorizer(
    ngram_range=(1, 3), 
    max_features=10000, 
    min_df=5 
)

# ğŸš¨ SMOTE Sampler
smote_sampler = SMOTE(random_state=42) 

# XGBoost Classifier
xgb_classifier = XGBClassifier(
    objective='multi:softprob', 
    eval_metric='mlogloss', 
    use_label_encoder=False, 
    random_state=42
) 

# ğŸš¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ImbPipeline Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ SMOTE
pipeline = ImbPipeline([
    ('tfidf', tfidf_vectorizer), # Ù…Ø±Ø­Ù„Ù‡ Û±: ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ Ø¨Ø±Ø¯Ø§Ø± 
    ('smote', smote_sampler),    # Ù…Ø±Ø­Ù„Ù‡ Û²: Ù…ØªØ¹Ø§Ø¯Ù„â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ (ÙÙ‚Ø· Ø±ÙˆÛŒ Ø¯Ø§Ø¯Ù‡ Ø¢Ù…ÙˆØ²Ø´)
    ('clf', xgb_classifier)      # Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¢Ù…ÙˆØ²Ø´ Ù…Ø¯Ù„
])

# --- Û². ØªÙ†Ø¸ÛŒÙ… Ù‡Ø§ÛŒÙ¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ (Grid Search) ---
param_grid = {
    # Ù‡Ø§ÛŒÙ¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ TF-IDF
    'tfidf__max_features': [5000, 10000], 
    # ğŸ’¡ Ù‡Ø§ÛŒÙ¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ SMOTE (ØªØ¹Ø¯Ø§Ø¯ Ù‡Ù…Ø³Ø§ÛŒÙ‡â€ŒÙ‡Ø§)
    'smote__k_neighbors': [3, 5], 
    # Ù‡Ø§ÛŒÙ¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ XGBoost
    'clf__n_estimators': [100, 200], 
    'clf__max_depth': [5, 7], 
    'clf__learning_rate': [0.1, 0.2] 
}

f1_macro_scorer = make_scorer(f1_score, average='macro')

print("ğŸš€ Ø´Ø±ÙˆØ¹ Grid Search Ùˆ Ø¢Ù…ÙˆØ²Ø´ Ù…Ø¯Ù„...")
grid_search_start = time.time()

grid_search = GridSearchCV(
    estimator=pipeline,
    param_grid=param_grid,
    scoring=f1_macro_scorer,
    cv=3, 
    verbose=1,
    n_jobs=-1
)

# Ø¢Ù…ÙˆØ²Ø´ Ù…Ø¯Ù„ Ø±ÙˆÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ (Ø´Ø§Ù…Ù„ SMOTE)
grid_search.fit(X_train, y_train)

grid_search_end = time.time()
training_time = grid_search_end - grid_search_start

best_model = grid_search.best_estimator_
best_params = grid_search.best_params_

print(f"\nâœ… Ø¢Ù…ÙˆØ²Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯. Ø²Ù…Ø§Ù† Ø¢Ù…ÙˆØ²Ø´: {training_time:.2f} Ø«Ø§Ù†ÛŒÙ‡")
print(f"âœ… Ø¨Ù‡ØªØ±ÛŒÙ† Ù‡Ø§ÛŒÙ¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÛŒØ§ÙØª Ø´Ø¯Ù‡: {best_params}")

# Û´. Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø±ÙˆÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Test
# Ù…Ø±Ø­Ù„Ù‡ SMOTE Ø¯Ø± ÙØ§Ø² ØªØ³Øª Pipeline Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
y_pred = best_model.predict(X_test)
y_prob = best_model.predict_proba(X_test)

print("\nØ²Ù…Ø§Ù† Ú©Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù„ÙˆÙ„ Û² (Ù…Ø¯Ù„Ø³Ø§Ø²ÛŒ):")
